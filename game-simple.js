// Planeta 2500 - Vers√£o Super Simples
// Jogo extremamente amig√°vel para todos os jogadores!

class SimpleGame {
    constructor() {
        this.gameState = {
            turn: 1,
            maxTurns: 10,
            money: 1000,
            solarPower: 0,      // Energia solar (MW)
            windPower: 0,       // Energia e√≥lica (MW)
            pollution: 0,       // Polui√ß√£o (0-100%)
            gameOver: false,
            tutorialStep: 1,
            tutorialActive: true
        };

        this.bindEvents();
        this.updateUI();
        this.showTutorial();
    }

    // Liga todos os eventos da interface
    bindEvents() {
        // Bot√µes de a√ß√£o
        document.getElementById('solar-btn').addEventListener('click', () => this.addSolar());
        document.getElementById('wind-btn').addEventListener('click', () => this.addWind());
        document.getElementById('cleanup-btn').addEventListener('click', () => this.cleanup());

        // Bot√£o principal
        document.getElementById('next-turn-btn').addEventListener('click', () => this.nextTurn());

        // Tutorial
        document.querySelectorAll('.tutorial-next-btn').forEach(btn => {
            btn.addEventListener('click', () => this.nextTutorialStep());
        });
        document.getElementById('start-game-btn').addEventListener('click', () => this.startGame());

        // Jogar novamente
        document.getElementById('play-again-btn').addEventListener('click', () => this.resetGame());
    }

    // A√ß√µes do jogador
    addSolar() {
        if (this.gameState.money >= 200) {
            this.gameState.money -= 200;
            this.gameState.solarPower += 10;
            this.addMessage('‚òÄÔ∏è Energia solar adicionada! Produz 10 MW de energia limpa.', 'success');
            this.updateUI();
        } else {
            this.addMessage('üí∏ Voc√™ n√£o tem dinheiro suficiente! Ganhe mais nos pr√≥ximos turnos.', 'warning');
        }
    }

    addWind() {
        if (this.gameState.money >= 150) {
            this.gameState.money -= 150;
            this.gameState.windPower += 5;
            this.addMessage('üí® Energia e√≥lica adicionada! Produz 5 MW de energia limpa.', 'success');
            this.updateUI();
        } else {
            this.addMessage('üí∏ Voc√™ n√£o tem dinheiro suficiente! Ganhe mais nos pr√≥ximos turnos.', 'warning');
        }
    }

    cleanup() {
        if (this.gameState.money >= 100) {
            this.gameState.money -= 100;
            this.gameState.pollution = Math.max(0, this.gameState.pollution - 20);
            this.addMessage('üßπ Planeta limpo! Polui√ß√£o reduzida em 20%.', 'success');
            this.updateUI();
        } else {
            this.addMessage('üí∏ Voc√™ n√£o tem dinheiro suficiente para limpar o planeta!', 'warning');
        }
    }

    // Avan√ßa para o pr√≥ximo turno
    nextTurn() {
        if (this.gameState.gameOver) return;

        // Calcula produ√ß√£o total de energia
        const totalEnergy = this.gameState.solarPower + this.gameState.windPower;
        const energyNeeded = 50; // Necessidade b√°sica

        // Ganha dinheiro baseado na energia produzida
        const moneyEarned = Math.floor(totalEnergy * 2); // $2 por MW
        this.gameState.money += moneyEarned;

        // Polui√ß√£o aumenta baseada na energia (menos polui√ß√£o se usar renov√°vel)
        const pollutionIncrease = Math.max(0, 15 - (totalEnergy * 0.1)); // Menos polui√ß√£o com mais energia renov√°vel
        this.gameState.pollution += pollutionIncrease;

        // Limita polui√ß√£o
        this.gameState.pollution = Math.min(100, this.gameState.pollution);

        // Avan√ßa turno
        this.gameState.turn++;

        // Log do turno
        this.addMessage(`‚è≠Ô∏è Turno ${this.gameState.turn - 1} terminado! Voc√™ ganhou $${moneyEarned}.`, 'info');

        if (pollutionIncrease > 0) {
            this.addMessage(`üå°Ô∏è Polui√ß√£o aumentou ${pollutionIncrease.toFixed(1)}% devido ao uso de energia n√£o-renov√°vel.`, 'warning');
        }

        // Verifica condi√ß√µes de vit√≥ria/derrota
        this.checkGameEnd();

        this.updateUI();
    }

    // Verifica se o jogo acabou
    checkGameEnd() {
        // Vit√≥ria: sobreviveu todos os turnos com polui√ß√£o baixa
        if (this.gameState.turn > this.gameState.maxTurns) {
            if (this.gameState.pollution <= 50) {
                this.showVictory();
            } else {
                this.showDefeat('Muita polui√ß√£o! O planeta ficou muito sujo.');
            }
            return;
        }

        // Derrota: polui√ß√£o muito alta
        if (this.gameState.pollution >= 80) {
            this.showDefeat('Polui√ß√£o excessiva! O planeta n√£o aguentou.');
            return;
        }

        // Derrota: sem dinheiro e sem energia
        const totalEnergy = this.gameState.solarPower + this.gameState.windPower;
        if (this.gameState.money < 100 && totalEnergy < 10) {
            this.showDefeat('Sem dinheiro e sem energia! Voc√™ n√£o conseguiu manter o planeta.');
            return;
        }
    }

    // Mostra vit√≥ria
    showVictory() {
        this.gameState.gameOver = true;
        const totalEnergy = this.gameState.solarPower + this.gameState.windPower;
        const score = this.gameState.money + (totalEnergy * 10) - (this.gameState.pollution * 5);

        document.getElementById('game-result-title').textContent = 'üéâ Parab√©ns! Voc√™ Venceu!';
        document.getElementById('game-result-message').textContent =
            `Voc√™ salvou o Planeta 2500! üéä\n\n` +
            `Energia total: ${totalEnergy} MW\n` +
            `Polui√ß√£o final: ${this.gameState.pollution.toFixed(1)}%\n` +
            `Pontua√ß√£o: ${score} pontos\n\n` +
            `Obrigado por jogar! üåçüíö`;

        document.getElementById('game-over-modal').classList.remove('hidden');
    }

    // Mostra derrota
    showDefeat(reason) {
        this.gameState.gameOver = true;

        document.getElementById('game-result-title').textContent = 'üòî Fim de Jogo';
        document.getElementById('game-result-message').textContent =
            `${reason}\n\n` +
            `Voc√™ chegou at√© o turno ${this.gameState.turn - 1}.\n` +
            `N√£o desanime! Tente novamente e foque em energia renov√°vel! üå±`;

        document.getElementById('game-over-modal').classList.remove('hidden');
    }

    // Atualiza toda a interface
    updateUI() {
        // Recursos
        document.getElementById('money-text').textContent = `$${this.gameState.money}`;
        document.getElementById('turn-text').textContent = `${this.gameState.turn} / ${this.gameState.maxTurns}`;

        // Energia
        const totalEnergy = this.gameState.solarPower + this.gameState.windPower;
        const energyPercent = Math.min(100, (totalEnergy / 50) * 100);

        document.getElementById('energy-bar').style.width = `${energyPercent}%`;
        document.getElementById('energy-text').textContent = `${totalEnergy}/50 MW`;

        // Polui√ß√£o
        document.getElementById('pollution-bar').style.width = `${this.gameState.pollution}%`;
        document.getElementById('pollution-text').textContent = `${this.gameState.pollution.toFixed(1)}%`;

        // Anima barras
        document.getElementById('energy-bar').classList.add('animate');
        document.getElementById('pollution-bar').classList.add('animate');

        setTimeout(() => {
            document.getElementById('energy-bar').classList.remove('animate');
            document.getElementById('pollution-bar').classList.remove('animate');
        }, 800);

        // Habilita/desabilita bot√µes
        this.updateButtons();

        // Atualiza objetivo
        this.updateObjective();
    }

    // Atualiza estado dos bot√µes
    updateButtons() {
        const solarBtn = document.getElementById('solar-btn');
        const windBtn = document.getElementById('wind-btn');
        const cleanupBtn = document.getElementById('cleanup-btn');
        const nextTurnBtn = document.getElementById('next-turn-btn');

        solarBtn.disabled = this.gameState.money < 200;
        windBtn.disabled = this.gameState.money < 150;
        cleanupBtn.disabled = this.gameState.money < 100;

        // Destaque no bot√£o principal se tutorial ativo
        if (this.gameState.tutorialActive && this.gameState.tutorialStep >= 4) {
            nextTurnBtn.classList.add('pulse');
        } else {
            nextTurnBtn.classList.remove('pulse');
        }
    }

    // Atualiza texto do objetivo
    updateObjective() {
        const turnsLeft = this.gameState.maxTurns - this.gameState.turn + 1;
        const objectiveText = document.getElementById('objective-text');

        if (this.gameState.gameOver) return;

        if (turnsLeft > 1) {
            objectiveText.textContent = `Sobreviva por mais ${turnsLeft} turnos e mantenha a polui√ß√£o abaixo de 50%!`;
        } else {
            objectiveText.textContent = `√öltimo turno! Mantenha a polui√ß√£o baixa para vencer!`;
        }

        // Cor baseada na situa√ß√£o
        if (this.gameState.pollution >= 60) {
            objectiveText.style.color = '#dc3545'; // Vermelho
        } else if (this.gameState.pollution >= 40) {
            objectiveText.style.color = '#ffc107'; // Amarelo
        } else {
            objectiveText.style.color = '#28a745'; // Verde
        }
    }

    // Adiciona mensagem ao log
    addMessage(text, type = 'info') {
        const messageList = document.getElementById('message-list');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = text;

        messageList.appendChild(messageDiv);
        messageList.scrollTop = messageList.scrollHeight;

        // Limita mensagens (mant√©m √∫ltimas 5)
        while (messageList.children.length > 5) {
            messageList.removeChild(messageList.firstChild);
        }
    }

    // Sistema de tutorial
    showTutorial() {
        document.getElementById('tutorial-modal').classList.remove('hidden');
        this.showTutorialStep(1);
    }

    showTutorialStep(step) {
        // Esconde todas as etapas
        document.querySelectorAll('.tutorial-step').forEach(el => {
            el.classList.add('hidden');
        });

        // Mostra a etapa atual
        document.getElementById(`step-${step}`).classList.remove('hidden');
    }

    nextTutorialStep() {
        this.gameState.tutorialStep++;
        this.showTutorialStep(this.gameState.tutorialStep);
    }

    startGame() {
        document.getElementById('tutorial-modal').classList.add('hidden');
        this.gameState.tutorialActive = false;
        this.addMessage('üéÆ Jogo iniciado! Boa sorte!', 'success');
    }

    // Reinicia o jogo
    resetGame() {
        this.gameState = {
            turn: 1,
            maxTurns: 10,
            money: 1000,
            solarPower: 0,
            windPower: 0,
            pollution: 0,
            gameOver: false,
            tutorialStep: 1,
            tutorialActive: true
        };

        document.getElementById('game-over-modal').classList.add('hidden');
        document.getElementById('message-list').innerHTML = `
            <div class="message welcome-message">
                üéâ Bem-vindo de volta ao Planeta 2500! Clique nos bot√µes acima para adicionar energia renov√°vel e mantenha o planeta limpo!
            </div>
        `;

        this.updateUI();
        this.showTutorial();
    }
}

// Inicia o jogo quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', () => {
    new SimpleGame();
});
